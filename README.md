# Сопоставление датасетов NQ и Efficient QA

Этот проект сопоставляет вопросы из датасета Efficient QA с соответствующими URL из датасета Natural Questions (NQ). Он помогает восстановить ссылки на источники, которые были удалены при создании датасета Efficient QA.

## Датасеты

### Входные данные

1. **Упрощенный датасет Natural Questions (NQ)**
   - Расположение: `simplified_qa/v1.0-simplified_simplified-nq-train.jsonl.gz`
   - Формат: Сжатый JSONL
   - Размер: ~4.4ГБ
   - Структура:
   ```json
   {
     "example_id": число,
     "document_url": "URL источника",
     "question_text": "текст вопроса",
     "document_text": "содержание документа",
     "annotations": [{
       "long_answer": { "start_token": число, "end_token": число },
       "short_answers": [{ "start_token": число, "end_token": число }],
       "yes_no_answer": "NONE"
     }]
   }
   ```

2. **Датасет Efficient QA**
   - Расположение: 
     - `efficient_qa/NQ-open.efficientqa.dev.1.1.jsonl`
     - `efficient_qa/NQ-open.efficientqa.test.1.1.jsonl`
   - Формат: JSONL
   - Структура:
   ```json
   {
     "question": "текст вопроса",
     "answer": ["текст ответа"]
   }
   ```

### Выходные файлы

1. **Обновленный датасет Efficient QA**
   - Расположение:
     - `efficient_qa/NQ-open.efficientqa.dev.with_refs.1.1.jsonl`
     - `efficient_qa/NQ-open.efficientqa.test.with_refs.1.1.jsonl`
   - Добавленные поля:
     - `document_url`: URL источника из датасета NQ
     - `nq_question`: Оригинальный вопрос из датасета NQ
     - `nq_similarity`: Оценка схожести (0.9-1.0)

2. **Несопоставленные вопросы**
   - Расположение:
     - `efficient_qa/unmatched_questions_dev.txt`
     - `efficient_qa/unmatched_questions_test.txt`
   - Содержит вопросы, для которых не найдено соответствие с высокой уверенностью

3. **Отчеты об обработке**
   - `processing.log`: Подробный лог обработки
   - `processing_report.txt`: Сводная статистика и примеры

## Требования

```bash
pip install -r requirements.txt
```

## Использование

```bash
python merge_datasets_simplified.py
```

## Алгоритм

1. **Нормализация вопросов**
   - Приведение к нижнему регистру
   - Удаление пунктуации
   - Удаление стоп-слов
   - Нормализация пробелов

2. **Процесс сопоставления**
   - Сначала пытается найти точное совпадение после нормализации
   - Если точного совпадения нет, ищет похожие вопросы
   - Требует оценку схожести ≥ 0.9 (коэффициент Жаккара)
   - Схожесть вычисляется как: |общие слова| / |уникальные слова|

3. **Особенности производительности**
   - Использует словарь в памяти для быстрого поиска
   - Обрабатывает данные батчами
   - Показывает прогресс каждые 10000 вопросов NQ
   - Показывает прогресс каждые 100 вопросов Efficient QA

## Анализ результатов

Скрипт предоставляет подробную статистику о:
- Количестве обработанных вопросов
- Количестве успешных сопоставлений
- Проценте успешных сопоставлений
- Примерах сопоставленных вопросов с оценками схожести
- Списке вопросов без совпадений

## Примечания

- Высокий порог схожести (0.9) обеспечивает качественные совпадения
- Вопросы из Efficient QA должны точно совпадать с вопросами из NQ, так как они были получены из этого датасета
- Время обработки зависит от характеристик машины, в первую очередь от объема оперативной памяти и скорости диска